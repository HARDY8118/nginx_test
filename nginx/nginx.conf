events {

}

http {

    include "mime.types";

    # Enable error logging for all http requests
    error_log logs/error.log error;

    # Enable and configure gzip
    gzip on;
    gzip_comp_level 3;
    gzip_types text/javascript;
    gzip_types text/css;
    gzip_types image/png;

    # Configure fastcgi microcache
    fastcgi_cache_path /tmp/nginx_cache levels=1:2 keys_zone=ZONE_1:256k inactive=1m;
    # Directories splitted as 1 charecter from last then 2 characters from start
    # Size of cache = 256 kilobytes lesser size will result in "ngx_slab_alloc() failed: no memory"
    # Delete cache after 1 minute
    
    fastcgi_cache_key "$request_method-$scheme-$host-$request_uri";
    # Set cache format as GET-http-localhost-index/file
    
    add_header X-Cache "Cache: $upstream_cache_status";
    # Add custom header to check if request served from cache

    server {
        # Listen on port 80
        listen 80;
        # Server domain
        server_name "localhost";

        # Root folder to serve static files
        root /usr/share/nginx/html;

        # Prefix match for /test
        location /test {
            # Will match /test/* Anything statring from /test
            # Return Message "OK" with status 200
            return 200 "OK";
        }

        # Exact match for /version
        location = /version {
            # Will match /version Only
            # Return Message "OK" with status 200
            return 200 "0.1";
        }

        # Regex match for /ping
        location ~ /ping[0-9]$ {
            # Will match */ping Anything matching regex (In this case ending with /ping followed by a digit)
            # Return Message "OK" with status 200
            return 200 "Success";
        }
        # ~* for insensitive match
        # Regex match more imporntant than prefix match
        # ^~ Preferencial prefix modifier
        # Exact > Preferencial > Regex > Prefix

        # Setting error pages
        error_page 404 "/Not Found.html";
        error_page 401 "/Unauthorized.html";

        # Exact match for /inspect
        location = /inspect {
            # Checking if admin variable is set to true
            if ( $arg_admin != true ) {
                set $error_msg "Admin not set";
                return 401 "$error_msg";
            }
            add_header err "Error: $error_msg";
            # Return 200 with variables
            return 200 "Host: $host\nPath: $uri\nArgs: $args\n$date_local";
        }

        location = /icon {
            # Performing rewrite, URL will change globally in request
            return 307 /res/favicon.ico;
        }

        # Will capture anything after /re/ and store in variable $1
        rewrite /re/(w+) /$1 last;
        # Adding last flag this uri won't be re-written

        # Performin internal rewrite, URL will not change globally but will be re-evaluted
        rewrite /home /;

        location = /log {
            # Log all access requests for /log requets
            access_log logs/access.log;
            return 201 "Logged";
        }

        # rewrite /logo /static/res/nginx_logo.png;

        # location = /static/res/nginx_logo.png {
        #     image_filter rotate 180;
        # }

        location = /res/nginx_logo.png {
            add_header image_name "nginx_logo";
        }

        # Cache all by default
        set $no_cache 0;

        # Set no cache to 1 if POST request
        if ( $request_method = POST) {
            set $no_cache 1;
        }

        # Requests matching certain extension
        location ~* \.(css|js|jpg|jpeg|png|ico) {
            # Turn off logging
            access_log off;

            # Headers for adjusting cache
            add_header Cache-Control public;
            add_header Pragma public;
            add_header Vary Accept-Encoding;
            # Response can Vary based on Accept-Encoding request header
            expires 1h;
            # Expire cache after 1 hour
            add_header cached "$date_local";

            # Set caching of resources
            fastcgi_cache ZONE_1;
            fastcgi_cache_valid 200 1m;
            fastcgi_cache_valid 404 10s;

            # Cache exception
            fastcgi_cache_bypass $no_cache;
            fastcgi_no_cache $no_cache;
        }
    }
}